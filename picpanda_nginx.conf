# 在 server 块外部定义缓存路径
# 缓存 zone: img_cache / 大小: 50g / 存期: 30天
proxy_cache_path /www/swift_cache levels=1:2 keys_zone=img_cache:100m max_size=50g inactive=30d use_temp_path=off;

server
{
    listen 80;
    listen [::]:80;
    server_name pickoala.com; 
    index index.html index.htm index.php;
    root /www/wwwroot/pickoala.com;
    
    # 【优化】开启 Gzip 压缩，显著提升网页加载速度
    gzip on;
    gzip_min_length 1k;
    gzip_buffers 4 16k;
    gzip_comp_level 5;
    gzip_types text/plain application/javascript application/x-javascript text/javascript text/xml text/css;
    gzip_vary on;
    gzip_disable "MSIE [1-6]\.";

    # 默认文档及字符集
    charset utf-8;

    # 【新增】支持 20GB 上传限制 (20480M)
    client_max_body_size 20480M;

    # ========================================================
    # 1. 核心转发：API 请求 (禁用缓存，确保数据实时性)
    # ========================================================
    location /api {
        # 转发到后端容器
        proxy_pass http://127.0.0.1:8000;
        
        # 基础请求头传递
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 禁用 API 缓存
        proxy_cache off;

        # --- 超时与大文件优化 ---
        proxy_connect_timeout 60s;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        # 实时流式上传
        proxy_request_buffering off;
    }

    # ========================================================
    # 2. 静态资源转发：图片代理（/img）及本地资源（/uploads）
    # ========================================================
    location ~ ^/(img|uploads) {
        # 转发到后端容器
        proxy_pass http://127.0.0.1:8000;
        
        # 基础请求头传递
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- 缓存配置 (针对图片和静态文件) ---
        proxy_cache img_cache;
        proxy_cache_valid 200 302 30d;
        proxy_cache_valid 404 1m;
        proxy_cache_key $host$uri$is_args$args;
        add_header X-Cache-Status $upstream_cache_status;
        
        # 隐藏 S3 相关的冗余响应头
        proxy_hide_header X-Amz-Request-Id;
        proxy_hide_header X-Amz-Id-2;
        proxy_hide_header x-amz-meta-code;
        proxy_ignore_headers Set-Cookie;

        # --- 超时设置 ---
        proxy_connect_timeout 60s;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        # 支持 Range 请求 (对于视频预览至关重要)
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
    }

    # ========================================================
    # 3. 前端页面路由支持 (Vue 3 History 模式)
    # ========================================================
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ========================================================
    # 4. 静态资源优化 (加速浏览器二次访问)
    # ========================================================
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ico)$
    {
        expires      30d;
        access_log off;
    }

    location ~ .*\.(js|css)?$
    {
        expires      12h;
        access_log off;
    }

    # 引入其他扩展 (保持宝塔默认)
    include /www/server/panel/vhost/nginx/extension/pickoala.com/*.conf;

    # 日志配置
    access_log  /www/wwwlogs/pickoala.log;
    error_log  /www/wwwlogs/pickoala.error.log;
}