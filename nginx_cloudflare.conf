# 在 server 块外部定义缓存路径
proxy_cache_path /www/swift_cache levels=1:2 keys_zone=img_cache:100m max_size=50g inactive=30d use_temp_path=off;

server
{
    listen 80;
    listen [::]:80;
    listen 443 ssl ;
    listen [::]:443 ssl ;
    http2 on;
    server_name pickoala.com;
    index index.html index.htm index.php;
    root /www/wwwroot/pickoala.com;

    # ========================================================
    # Cloudflare Real IP Configuration
    # 使用服务器自动维护的 CF IP 列表
    # ========================================================
    include /www/server/nginx/conf/cloudflare_ips.conf;

    # [FIX] 如果 cloudflare_ips.conf 中已经包含 real_ip_header，则此处必须注释掉，否则会报错 duplicate
    # real_ip_header CF-Connecting-IP;

    # ========================================================
    # SSL 配置
    # ========================================================
    ssl_certificate    /www/server/panel/vhost/cert/pickoala.com/fullchain.pem;
    ssl_certificate_key    /www/server/panel/vhost/cert/pickoala.com/privkey.pem;
    
    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers EECDH+CHACHA20:EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    add_header Strict-Transport-Security "max-age=31536000";

    # 已移除强制 HTTPS 跳转逻辑

    # ========================================================
    # 基础优化与上传限制
    # ========================================================
    gzip on;
    gzip_min_length 1k;
    gzip_types text/plain application/javascript application/x-javascript text/javascript text/xml text/css;
    
    # [INFO] 前端使用分片上传 (Chunked Upload) 绕过 Cloudflare 100MB 限制
    # 此处 20GB 限制用于支持大文件分片后的总大小或合并操作
    client_max_body_size 20480M; 

    # ========================================================
    # 1. 核心转发：API 请求
    # ========================================================
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        
        # 修改: 使用 $remote_addr 即可，因为上面已经配置了 set_real_ip_from
        # Nginx 会自动把 CF-Connecting-IP 赋值给 $remote_addr
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache off; 
        proxy_connect_timeout 60s;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_request_buffering off;
    }

    # ========================================================
    # 2. 静态资源转发：图片代理（/img）及本地资源（/uploads）
    # ========================================================
    location ~ ^/(img|uploads) {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache img_cache;
        proxy_cache_valid 200 302 30d;
        proxy_cache_key $host$uri$is_args$args;
        add_header X-Cache-Status $upstream_cache_status;
        
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
    }

    # ========================================================
    # 3. 前端页面路由支持 (Vue 3 History 模式)
    # ========================================================
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 4. 静态资源浏览器缓存优化
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ico)$ {
        expires 30d;
        access_log off;
    }

    location ~ .*\.(js|css)?$ {
        expires 12h;
        access_log off;
    }

    # 引入扩展与日志
    include /www/server/panel/vhost/nginx/extension/pickoala.com/*.conf;
    
    # 关键标识行
    #error_page 404 /404.html;

    access_log  /www/wwwlogs/pickoala.log;
    error_log  /www/wwwlogs/pickoala.error.log;
}
